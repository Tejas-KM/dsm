<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accurate Distance Measurement - OpenCV Enhanced</title>
    <meta name="description" content="High-accuracy distance measurement using OpenCV.js perspective correction">
    <link rel="stylesheet" href="styles/style.css">
    <!-- OpenCV.js for advanced computer vision -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <!-- Three.js for WebXR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <h1>üìè Accurate Distance Meter</h1>
            <div class="header-controls">
                <select id="unitSelector" class="form-control unit-selector">
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m" selected>meters</option>
                    <option value="in">inches</option>
                    <option value="ft">feet</option>
                </select>
                <button id="settingsBtn" class="settings-btn" title="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mode Selection Screen -->
            <div id="modeSelection" class="mode-selection">
                <div class="app-intro">
                    <h2>üéØ Professional Distance Measurement</h2>
                    <p>Enhanced with OpenCV perspective correction for accurate results</p>
                </div>
                
                <div class="opencv-status">
                    <div id="opencvStatus" class="status-indicator loading">
                        <span class="status-dot"></span>
                        <span class="status-text">Loading OpenCV.js...</span>
                    </div>
                </div>
                
                <div class="capability-info">
                    <div id="webxrStatus" class="capability-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Checking WebXR support...</span>
                    </div>
                </div>
                
                <div class="mode-buttons">
                    <button id="precisionModeBtn" class="mode-btn precision-mode">
                        <div class="mode-icon">üî¨</div>
                        <div class="mode-title">Precision Mode</div>
                        <div class="mode-description">OpenCV perspective correction for high accuracy</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Perspective correction</span>
                            <span class="feature">‚úì Lens distortion removal</span>
                            <span class="feature">‚úì Multi-point calibration</span>
                            <span class="feature">‚úì ¬±2-5% accuracy</span>
                        </div>
                    </button>
                    
                    <button id="arModeBtn" class="mode-btn ar-mode" disabled>
                        <div class="mode-icon">ü•Ω</div>
                        <div class="mode-title">AR Mode</div>
                        <div class="mode-description">WebXR for supported devices</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Sub-centimeter accuracy</span>
                            <span class="feature">‚úì 3D surface detection</span>
                            <span class="feature">‚úì Real-time tracking</span>
                        </div>
                    </button>
                    
                    <button id="basicModeBtn" class="mode-btn basic-mode">
                        <div class="mode-icon">üì∑</div>
                        <div class="mode-title">Basic Mode</div>
                        <div class="mode-description">Simple measurement for quick tasks</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Universal compatibility</span>
                            <span class="feature">‚úì Quick setup</span>
                            <span class="feature">‚úì Good for small objects</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Camera View Container -->
            <div id="cameraContainer" class="camera-container hidden">
                <video id="cameraVideo" class="camera-video hidden" autoplay muted playsinline></video>
                <canvas id="measurementCanvas" class="measurement-canvas hidden"></canvas>
                <canvas id="opencvCanvas" class="opencv-canvas hidden"></canvas>
                <div id="arContainer" class="ar-container hidden"></div>
                
                <!-- Camera Overlay UI -->
                <div class="camera-overlay">
                    <div class="measurement-info">
                        <div id="currentDistance" class="current-distance hidden">
                            <span class="distance-value">0.00</span>
                            <span class="distance-unit">m</span>
                            <div class="accuracy-badge">
                                <span id="accuracyBadge" class="accuracy-text">High Precision</span>
                            </div>
                        </div>
                        
                        <div id="calibrationStatus" class="calibration-status hidden">
                            <div class="calibration-progress">
                                <div class="progress-bar">
                                    <div id="progressFill" class="progress-fill"></div>
                                </div>
                                <span id="calibrationText" class="calibration-text">Place reference object</span>
                            </div>
                        </div>
                        
                        <div id="instructionsText" class="instructions-text">
                            Point your camera at objects and start measuring
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="measureBtn" class="control-btn measure-btn">
                            <span class="btn-icon">üìê</span>
                            <span class="btn-text">Start Precision Measurement</span>
                        </button>
                        <button id="clearBtn" class="control-btn clear-btn hidden">
                            <span class="btn-icon">üóëÔ∏è</span>
                            <span class="btn-text">Clear</span>
                        </button>
                        <button id="undoBtn" class="control-btn undo-btn hidden">
                            <span class="btn-icon">‚Ü∂</span>
                            <span class="btn-text">Undo</span>
                        </button>
                        <button id="backBtn" class="control-btn back-btn">
                            <span class="btn-icon">‚¨ÖÔ∏è</span>
                            <span class="btn-text">Back</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Precision Calibration Modal -->
            <div id="precisionCalibrationModal" class="modal hidden">
                <div class="modal-content precision-calibration">
                    <h3>üî¨ Precision Calibration Setup</h3>
                    <p>For maximum accuracy, we'll use 4-corner perspective correction with OpenCV</p>
                    
                    <div class="calibration-method">
                        <label>Choose calibration method:</label>
                        <div class="method-options">
                            <label class="method-option">
                                <input type="radio" name="calibrationMethod" value="rectangle" checked>
                                <span class="option-content">
                                    <strong>üìÑ Rectangle Object</strong>
                                    <small>Credit card, paper, book, etc.</small>
                                </span>
                            </label>
                            <label class="method-option">
                                <input type="radio" name="calibrationMethod" value="square">
                                <span class="option-content">
                                    <strong>‚¨ú Square Object</strong>
                                    <small>Post-it note, tile, etc.</small>
                                </span>
                            </label>
                            <label class="method-option">
                                <input type="radio" name="calibrationMethod" value="custom">
                                <span class="option-content">
                                    <strong>üìè Custom Dimensions</strong>
                                    <small>Enter exact measurements</small>
                                </span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="referenceObjectSelector" class="reference-objects">
                        <label for="precisionReferenceSelect">Reference Object:</label>
                        <select id="precisionReferenceSelect" class="reference-select">
                            <option value="credit_card">Credit Card (85.6mm √ó 53.98mm)</option>
                            <option value="business_card">Business Card (89mm √ó 51mm)</option>
                            <option value="a4_paper">A4 Paper (210mm √ó 297mm)</option>
                            <option value="letter_paper">US Letter (216mm √ó 279mm)</option>
                            <option value="post_it">Post-it Note (76mm √ó 76mm)</option>
                            <option value="custom">Custom Dimensions</option>
                        </select>
                    </div>
                    
                    <div id="customDimensions" class="custom-dimensions hidden">
                        <div class="dimension-inputs">
                            <div class="input-group">
                                <label for="customWidth">Width (mm):</label>
                                <input type="number" id="customWidth" placeholder="85.6" step="0.1">
                            </div>
                            <div class="input-group">
                                <label for="customHeight">Height (mm):</label>
                                <input type="number" id="customHeight" placeholder="53.98" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="precision-instructions">
                        <h4>üìã Calibration Steps:</h4>
                        <ol>
                            <li><strong>Place object flat</strong> on the same surface as items to measure</li>
                            <li><strong>Ensure good lighting</strong> and avoid shadows</li>
                            <li><strong>Click all 4 corners</strong> in order: top-left ‚Üí top-right ‚Üí bottom-right ‚Üí bottom-left</li>
                            <li><strong>OpenCV will correct</strong> perspective distortion automatically</li>
                        </ol>
                        <div class="accuracy-note">
                            <strong>üéØ Expected Accuracy:</strong> ¬±2-5% with proper calibration
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="startPrecisionCalibrationBtn" class="btn-primary">
                            üöÄ Start Precision Calibration
                        </button>
                        <button id="skipCalibrationBtn" class="btn-secondary">
                            Skip (Use Basic Mode)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Display Panel -->
            <div id="resultsPanel" class="results-panel hidden">
                <div class="results-header">
                    <h3>üìä Measurement Results</h3>
                    <div class="results-summary">
                        <span id="measurementCount">0 measurements</span>
                        <span id="accuracyLevel" class="accuracy-level">High Precision</span>
                    </div>
                </div>
                
                <div id="measurementsList" class="measurements-list">
                    <!-- Measurements will be populated here -->
                </div>
                
                <div class="results-actions">
                    <button id="exportBtn" class="btn-secondary">
                        <span class="btn-icon">üì§</span>
                        <span class="btn-text">Export Data</span>
                    </button>
                    <button id="newMeasurementBtn" class="btn-primary">
                        <span class="btn-icon">üÜï</span>
                        <span class="btn-text">New Measurement</span>
                    </button>
                    <button id="recalibrateBtn" class="btn-secondary">
                        <span class="btn-icon">üîÑ</span>
                        <span class="btn-text">Recalibrate</span>
                    </button>
                </div>
            </div>

            <!-- Settings Modal -->
            <div id="settingsModal" class="modal hidden">
                <div class="modal-content">
                    <h3>‚öôÔ∏è Settings</h3>
                    
                    <div class="settings-section">
                        <h4>Camera Settings</h4>
                        <div class="setting-item">
                            <label for="cameraResolution">Resolution:</label>
                            <select id="cameraResolution">
                                <option value="1920x1080" selected>1920√ó1080 (Recommended)</option>
                                <option value="1280x720">1280√ó720</option>
                                <option value="3840x2160">3840√ó2160 (4K)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="stabilizationMode" checked>
                                <span>Image stabilization</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Measurement Settings</h4>
                        <div class="setting-item">
                            <label for="accuracyMode">Accuracy Mode:</label>
                            <select id="accuracyMode">
                                <option value="high" selected>High Precision (Slower)</option>
                                <option value="balanced">Balanced</option>
                                <option value="fast">Fast (Lower accuracy)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label for="decimalPlaces">Decimal Places:</label>
                            <select id="decimalPlaces">
                                <option value="1">1</option>
                                <option value="2" selected>2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="saveSettingsBtn" class="btn-primary">Save Settings</button>
                        <button id="closeSettingsBtn" class="btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-icon">üìè</div>
            <h2>Accurate Distance Meter</h2>
            <div class="loading-spinner"></div>
            <p id="loadingText">Loading OpenCV.js for precision measurement...</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div id="loadingProgress" class="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/opencv-enhanced-app.js"></script>
</body>
</html>