<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accurate Distance Measurement - Fixed</title>
    <meta name="description" content="High-accuracy distance measurement with OpenCV fallback">
    <link rel="stylesheet" href="styles/style.css">
    <!-- Three.js for WebXR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <h1>üìè Accurate Distance Meter</h1>
            <div class="header-controls">
                <select id="unitSelector" class="form-control unit-selector">
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m" selected>meters</option>
                    <option value="in">inches</option>
                    <option value="ft">feet</option>
                </select>
                <button id="settingsBtn" class="settings-btn" title="Settings">‚öôÔ∏è</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mode Selection Screen -->
            <div id="modeSelection" class="mode-selection">
                <div class="app-intro">
                    <h2>üéØ Professional Distance Measurement</h2>
                    <p>Enhanced accuracy with perspective correction</p>
                </div>
                
                <div class="opencv-status">
                    <div id="opencvStatus" class="status-indicator loading">
                        <span class="status-dot"></span>
                        <span class="status-text">Loading enhanced features...</span>
                    </div>
                </div>
                
                <div class="capability-info">
                    <div id="webxrStatus" class="capability-status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Checking WebXR support...</span>
                    </div>
                </div>
                
                <div class="mode-buttons">
                    <button id="precisionModeBtn" class="mode-btn precision-mode">
                        <div class="mode-icon">üî¨</div>
                        <div class="mode-title">Precision Mode</div>
                        <div class="mode-description">4-corner perspective correction for high accuracy</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Perspective correction</span>
                            <span class="feature">‚úì Multi-point calibration</span>
                            <span class="feature">‚úì ¬±2-5% accuracy</span>
                        </div>
                    </button>
                    
                    <button id="arModeBtn" class="mode-btn ar-mode" disabled>
                        <div class="mode-icon">ü•Ω</div>
                        <div class="mode-title">AR Mode</div>
                        <div class="mode-description">WebXR for supported devices</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Sub-centimeter accuracy</span>
                            <span class="feature">‚úì 3D surface detection</span>
                        </div>
                    </button>
                    
                    <button id="basicModeBtn" class="mode-btn basic-mode">
                        <div class="mode-icon">üì∑</div>
                        <div class="mode-title">Enhanced Basic Mode</div>
                        <div class="mode-description">Improved triangle similarity with better calibration</div>
                        <div class="mode-features">
                            <span class="feature">‚úì Universal compatibility</span>
                            <span class="feature">‚úì Better accuracy than before</span>
                            <span class="feature">‚úì Quick setup</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Camera View Container -->
            <div id="cameraContainer" class="camera-container hidden">
                <video id="cameraVideo" class="camera-video hidden" autoplay muted playsinline></video>
                <canvas id="measurementCanvas" class="measurement-canvas hidden"></canvas>
                <canvas id="opencvCanvas" class="opencv-canvas hidden"></canvas>
                
                <!-- Camera Overlay UI -->
                <div class="camera-overlay">
                    <div class="measurement-info">
                        <div id="currentDistance" class="current-distance hidden">
                            <span class="distance-value">0.00</span>
                            <span class="distance-unit">m</span>
                            <div class="accuracy-badge">
                                <span id="accuracyBadge" class="accuracy-text">High Precision</span>
                            </div>
                        </div>
                        
                        <div id="calibrationStatus" class="calibration-status hidden">
                            <div class="calibration-progress">
                                <div class="progress-bar">
                                    <div id="progressFill" class="progress-fill"></div>
                                </div>
                                <span id="calibrationText" class="calibration-text">Place reference object</span>
                            </div>
                        </div>
                        
                        <div id="instructionsText" class="instructions-text">
                            Point your camera at objects and start measuring
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="measureBtn" class="control-btn measure-btn">
                            <span class="btn-icon">üìê</span>
                            <span class="btn-text">Start Measuring</span>
                        </button>
                        <button id="clearBtn" class="control-btn clear-btn hidden">
                            <span class="btn-icon">üóëÔ∏è</span>
                            <span class="btn-text">Clear</span>
                        </button>
                        <button id="undoBtn" class="control-btn undo-btn hidden">
                            <span class="btn-icon">‚Ü∂</span>
                            <span class="btn-text">Undo</span>
                        </button>
                        <button id="backBtn" class="control-btn back-btn">
                            <span class="btn-icon">‚¨ÖÔ∏è</span>
                            <span class="btn-text">Back</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Precision Calibration Modal -->
            <div id="precisionCalibrationModal" class="modal hidden">
                <div class="modal-content precision-calibration">
                    <h3>üî¨ Precision Calibration Setup</h3>
                    <p>For maximum accuracy, we'll use 4-corner perspective correction</p>
                    
                    <div class="reference-objects">
                        <label for="precisionReferenceSelect">Reference Object:</label>
                        <select id="precisionReferenceSelect" class="reference-select">
                            <option value="credit_card">Credit Card (85.6mm √ó 53.98mm)</option>
                            <option value="business_card">Business Card (89mm √ó 51mm)</option>
                            <option value="a4_paper">A4 Paper (210mm √ó 297mm)</option>
                            <option value="letter_paper">US Letter (216mm √ó 279mm)</option>
                            <option value="post_it">Post-it Note (76mm √ó 76mm)</option>
                        </select>
                    </div>
                    
                    <div class="precision-instructions">
                        <h4>üìã Calibration Steps:</h4>
                        <ol>
                            <li><strong>Place object flat</strong> on the same surface as items to measure</li>
                            <li><strong>Ensure good lighting</strong> and avoid shadows</li>
                            <li><strong>Click all 4 corners</strong> in order: top-left ‚Üí top-right ‚Üí bottom-right ‚Üí bottom-left</li>
                            <li><strong>System will correct</strong> perspective distortion automatically</li>
                        </ol>
                        <div class="accuracy-note">
                            <strong>üéØ Expected Accuracy:</strong> ¬±2-5% with proper calibration
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="startPrecisionCalibrationBtn" class="btn-primary">
                            üöÄ Start Precision Calibration
                        </button>
                        <button id="skipCalibrationBtn" class="btn-secondary">
                            Use Enhanced Basic Mode
                        </button>
                    </div>
                </div>
            </div>

            <!-- Basic Calibration Modal -->
            <div id="basicCalibrationModal" class="modal hidden">
                <div class="modal-content">
                    <h3>üìè Enhanced Basic Calibration</h3>
                    <p>Improved single-camera measurement with better accuracy</p>
                    
                    <div class="reference-objects">
                        <label for="basicReferenceSelect">Choose your reference object:</label>
                        <select id="basicReferenceSelect" class="reference-select">
                            <option value="credit_card">Credit Card (85.6mm √ó 53.98mm)</option>
                            <option value="quarter">US Quarter (24.26mm diameter)</option>
                            <option value="business_card">Business Card (89mm √ó 51mm)</option>
                            <option value="a4_paper">A4 Paper (210mm √ó 297mm)</option>
                        </select>
                    </div>
                    
                    <div class="calibration-instructions">
                        <h4>Calibration Steps:</h4>
                        <ol>
                            <li>Place the selected object clearly in camera view</li>
                            <li>Ensure the object is flat and well-lit</li>
                            <li>Click on both ends of the object's width</li>
                            <li>The app will calculate the scale factor</li>
                        </ol>
                        <div class="tip">
                            <strong>üí° Tip:</strong> Keep reference object at same distance as measurement target
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="startBasicCalibrationBtn" class="btn-primary">
                            Start Enhanced Calibration
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Display Panel -->
            <div id="resultsPanel" class="results-panel hidden">
                <div class="results-header">
                    <h3>üìä Measurement Results</h3>
                    <div class="results-summary">
                        <span id="measurementCount">0 measurements</span>
                        <span id="accuracyLevel" class="accuracy-level">High Precision</span>
                    </div>
                </div>
                
                <div id="measurementsList" class="measurements-list"></div>
                
                <div class="results-actions">
                    <button id="exportBtn" class="btn-secondary">
                        <span class="btn-icon">üì§</span>
                        <span class="btn-text">Export Data</span>
                    </button>
                    <button id="newMeasurementBtn" class="btn-primary">
                        <span class="btn-icon">üÜï</span>
                        <span class="btn-text">New Measurement</span>
                    </button>
                    <button id="recalibrateBtn" class="btn-secondary">
                        <span class="btn-icon">üîÑ</span>
                        <span class="btn-text">Recalibrate</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-icon">üìè</div>
            <h2>Accurate Distance Meter</h2>
            <div class="loading-spinner"></div>
            <p id="loadingText">Initializing measurement system...</p>
            <div class="loading-progress">
                <div class="progress-bar">
                    <div id="loadingProgress" class="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIXED: Changed to reference existing app.js file -->
    <script src="scripts/app.js"></script>
    
    <!-- Load OpenCV.js asynchronously with fallback -->
    <script>
        // Define OpenCV callback BEFORE loading OpenCV
        window.onOpenCvReady = function() {
            console.log('‚úÖ OpenCV.js loaded successfully');
            if (window.accurateDistanceApp) {
                window.accurateDistanceApp.onOpenCVReady();
            }
        };
        
        // Try to load OpenCV.js with multiple fallbacks
        function loadOpenCV() {
            const script = document.createElement('script');
            script.async = true;
            script.type = 'text/javascript';
            
            // Try multiple CDN sources
            const cdnSources = [
                'https://docs.opencv.org/4.8.0/opencv.js',
                'https://cdn.jsdelivr.net/npm/opencv.js@4.8.0/opencv.js',
                'https://unpkg.com/opencv.js@4.8.0/opencv.js'
            ];
            
            let currentCDN = 0;
            
            function tryNextCDN() {
                if (currentCDN < cdnSources.length) {
                    script.src = cdnSources[currentCDN];
                    script.onload = window.onOpenCvReady;
                    script.onerror = () => {
                        console.warn(`Failed to load OpenCV from: ${cdnSources[currentCDN]}`);
                        currentCDN++;
                        tryNextCDN();
                    };
                    document.head.appendChild(script);
                } else {
                    console.warn('‚ö†Ô∏è OpenCV.js failed to load from all sources. Using fallback mode.');
                    if (window.accurateDistanceApp) {
                        window.accurateDistanceApp.onOpenCVFailed();
                    }
                }
            }
            
            tryNextCDN();
        }
        
        // Start loading OpenCV after a short delay
        setTimeout(loadOpenCV, 500);
    </script>
</body>
</html>